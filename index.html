<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Ø¬Ù„Ø³Ø© Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ… | Love Session</title>
  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #17132e 0, #050409 45%, #020108 100%);
      --card-bg: rgba(20, 16, 40, 0.7);
      --card-border: rgba(255, 255, 255, 0.08);
      --text-main: #fdfbff;
      --text-muted: #b4b0c9;
      --accent: #ff9f4a;
      --accent-2: #ff4a8d;
      --success: #00c853;
      --shadow-soft: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
      --radius-lg: 24px;
      --radius-md: 16px;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --backdrop-blur: blur(12px);
    }

    :root[data-theme="light"] {
      --bg-main: radial-gradient(circle at top left, #fff0f5 0, #f3e5f5 45%, #ffffff 100%);
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border: rgba(0, 0, 0, 0.05);
      --text-main: #2d1b36;
      --text-muted: #6a5a75;
      --shadow-soft: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
    }

    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© */
    :root[data-mode="love"] { --accent: #ff4a8d; --accent-2: #ffb84a; }
    :root[data-mode="engaged"] { --accent: #00d2ff; --accent-2: #3a7bd5; }
    :root[data-mode="married"] { --accent: #00b09b; --accent-2: #96c93d; }
    :root[data-mode="special"] { --accent: #8e2de2; --accent-2: #4a00e0; }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-family);
      background: var(--bg-main);
      background-attachment: fixed;
      color: var(--text-main);
      direction: rtl;
      transition: background 0.5s ease;
      overflow-x: hidden;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
      animation: fadeInDown 0.8s ease;
    }

    .logo-area { display: flex; align-items: center; gap: 0.8rem; }
    .logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-radius: 50%;
      display: grid; place-items: center;
      font-size: 1.2rem; color: #fff;
      box-shadow: 0 0 15px var(--accent);
    }
    .logo-text h1 { margin: 0; font-size: 1.2rem; font-weight: 800; }
    .logo-text p { margin: 0; font-size: 0.8rem; color: var(--text-muted); }

    .action-buttons { display: flex; gap: 0.5rem; }
    
    .btn-icon {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      color: var(--text-main);
      width: 40px; height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: grid; place-items: center;
      transition: 0.3s;
      backdrop-filter: var(--backdrop-blur);
    }
    .btn-icon:hover { transform: translateY(-2px); border-color: var(--accent); color: var(--accent); }

    /* Layout Grid */
    .grid-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1.5rem;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      backdrop-filter: var(--backdrop-blur);
      box-shadow: var(--shadow-soft);
      transition: transform 0.3s ease, border-color 0.3s ease;
    }
    .card:hover { border-color: rgba(255,255,255,0.15); }

    .card-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .card-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.5; }

    /* Music Player Enhanced */
    .music-player { position: relative; overflow: hidden; }
    .visualizer {
      display: flex; gap: 3px; height: 30px; align-items: flex-end; justify-content: center;
      margin-bottom: 1rem; opacity: 0.5; transition: 0.3s;
    }
    .visualizer.playing { opacity: 1; }
    .bar { width: 4px; background: var(--accent); border-radius: 2px; animation: bounce 1s infinite; }
    .bar:nth-child(odd) { animation-duration: 0.8s; background: var(--accent-2); }

    .file-input-wrapper {
      position: relative;
      border: 2px dashed var(--card-border);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      text-align: center;
      transition: 0.3s;
      cursor: pointer;
    }
    .file-input-wrapper:hover, .file-input-wrapper.dragover {
      border-color: var(--accent);
      background: rgba(255,255,255,0.03);
    }
    .upload-btn {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border: none; color: #fff; padding: 8px 20px; border-radius: 20px;
      font-weight: 600; cursor: pointer; pointer-events: none;
    }

    .music-controls { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }
    .ctrl-btn {
      background: none; border: 1px solid var(--card-border); color: var(--text-main);
      width: 35px; height: 35px; border-radius: 50%; cursor: pointer; transition: 0.2s;
    }
    .ctrl-btn:hover:not(:disabled) { background: var(--accent); border-color: var(--accent); color: #fff; }
    .ctrl-btn:disabled { opacity: 0.3; cursor: default; }

    /* Question Section */
    .filter-tags { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    .tag-btn {
      background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
      color: var(--text-muted); padding: 5px 12px; border-radius: 20px;
      font-size: 0.75rem; white-space: nowrap; cursor: pointer; transition: 0.2s;
    }
    .tag-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    .display-area {
      min-height: 140px;
      background: rgba(0,0,0,0.2);
      border-radius: var(--radius-md);
      display: grid; place-items: center;
      padding: 1.5rem;
      text-align: center;
      position: relative;
      border: 1px solid var(--card-border);
      margin-bottom: 1rem;
    }
    [data-theme="light"] .display-area { background: rgba(0,0,0,0.03); }

    .question-text { font-size: 1.1rem; line-height: 1.6; font-weight: 500; }
    .cursor::after { content: '|'; animation: blink 1s infinite; color: var(--accent); }

    .actions-row { display: flex; gap: 0.8rem; flex-wrap: wrap; }
    .action-btn {
      flex: 1; padding: 12px; border: none; border-radius: var(--radius-md);
      font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: 0.3s;
    }
    .btn-primary { background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid var(--card-border); color: var(--text-main); }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-ai { background: linear-gradient(45deg, #8e2de2, #4a00e0); color: #fff; position: relative; overflow: hidden; }
    .btn-ai::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shine 3s infinite;
    }

    /* List of Questions */
    .q-list { max-height: 300px; overflow-y: auto; padding-left: 5px; }
    .q-item {
      padding: 10px; border-bottom: 1px solid var(--card-border);
      font-size: 0.85rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between;
    }
    .q-item:hover { background: rgba(255,255,255,0.03); padding-right: 5px; }
    .q-item.active { border-right: 3px solid var(--accent); background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent); }

    /* Relation Modes */
    .mode-selector { display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 30px; margin-bottom: 1rem; }
    [data-theme="light"] .mode-selector { background: rgba(0,0,0,0.05); }
    .mode-btn {
      flex: 1; background: transparent; border: none; padding: 8px; color: var(--text-muted);
      border-radius: 25px; cursor: pointer; font-size: 0.8rem; transition: 0.3s;
    }
    .mode-btn.active { background: var(--card-bg); color: var(--text-main); font-weight: 700; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

    /* Toast Notification */
    .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; }
    .toast {
      background: rgba(20, 20, 20, 0.9); color: #fff; padding: 10px 20px; border-radius: 30px;
      margin-top: 10px; font-size: 0.9rem; opacity: 0; transform: translateY(20px); transition: 0.4s;
      display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px);
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border-color: var(--success); }

    /* Modals */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 90;
      opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal-box {
      background: #151226; width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius-lg);
      transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid var(--card-border); color: #fff;
    }
    [data-theme="light"] .modal-box { background: #fff; color: #333; }
    .modal-overlay.open .modal-box { transform: scale(1); }

    /* Keyframes */
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bounce { 0%, 100% { height: 5px; } 50% { height: 20px; } }
    @keyframes blink { 50% { opacity: 0; } }
    @keyframes shine { 100% { left: 100%; } }

    /* Responsive */
    @media (max-width: 850px) {
      .grid-layout { grid-template-columns: 1fr; }
      .app-shell { padding: 1rem; }
    }
  </style>
</head>
<body>

<div class="app-shell">
  <header class="top-bar">
    <div class="logo-area">
      <div class="logo-icon">â¤</div>
      <div class="logo-text">
        <h1>Ø¬Ù„Ø³Ø© Ø­Ø¨</h1>
        <p>Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø­ÙˆØ§Ø± ÙˆØ§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ÙˆØ§Ù„Ù…Ø´Ø§Ø¹Ø±</p>
      </div>
    </div>
    <div class="action-buttons">
      <button class="btn-icon" id="theme-toggle" title="ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¸Ù‡Ø±">ğŸŒ™</button>
      <button class="btn-icon" id="settings-btn" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™</button>
    </div>
  </header>

  <div class="grid-layout">
    
    <aside>
      <div class="card music-player">
        <div class="card-title"><span>â™«</span> Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø©</div>
        
        <div class="visualizer" id="visualizer">
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>

        <div class="file-input-wrapper" id="drop-zone">
          <div class="upload-btn">Ø§Ø®ØªØ± Ù…Ù„Ù ØµÙˆØªÙŠ</div>
          <div style="font-size:0.7rem; margin-top:5px; opacity:0.7">Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</div>
          <input type="file" id="audio-input" accept="audio/*" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        </div>

        <div class="music-info" style="text-align:center; margin-top:10px; font-size:0.8rem; height:20px;">
          <span id="track-name">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù</span>
        </div>

        <div class="music-controls">
          <button class="ctrl-btn" id="btn-loop" title="ØªÙƒØ±Ø§Ø±">â†»</button>
          <button class="ctrl-btn" id="btn-play" disabled title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">â–¶</button>
          <button class="ctrl-btn" id="btn-stop" disabled title="Ø¥ÙŠÙ‚Ø§Ù">â– </button>
        </div>
        <audio id="main-audio"></audio>
      </div>

      <div class="card">
        <div class="card-title"><span>â˜…</span> Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø­Ø¨</div>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <button class="btn-secondary action-btn" onclick="openModal('memories-modal')">ğŸ“” Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§</button>
          <button class="btn-secondary action-btn" onclick="openModal('goals-modal')">ğŸ¯ Ø£Ù‡Ø¯Ø§Ù Ù…Ø´ØªØ±ÙƒØ©</button>
          <button class="btn-secondary action-btn" onclick="openModal('game-modal')">ğŸ² Ù„Ø¹Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©</button>
        </div>
      </div>
    </aside>

    <main>
      <div class="mode-selector" id="mode-selector">
        <button class="mode-btn active" data-mode="love">Ø­Ø¨ & ØªØ¹Ø§Ø±Ù</button>
        <button class="mode-btn" data-mode="engaged">Ø®Ø·ÙˆØ¨Ø©</button>
        <button class="mode-btn" data-mode="married">Ø²ÙˆØ§Ø¬</button>
        <button class="mode-btn" data-mode="special">Ø®Ø§Øµ</button>
      </div>

      <div class="card">
        <div class="card-title" style="justify-content:space-between">
          <span>ğŸ’¬ Ø£Ø³Ø¦Ù„Ø© Ø¹Ù…ÙŠÙ‚Ø©</span>
          <span style="font-size:0.7rem; opacity:0.6" id="q-count">0 Ø³Ø¤Ø§Ù„</span>
        </div>

        <div class="filter-tags" id="tags-container">
          </div>

        <div class="display-area">
          <div id="question-text" class="question-text">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø³Ø¤Ø§Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ" Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø©...</div>
        </div>

        <div class="actions-row">
          <button class="action-btn btn-secondary" id="btn-copy">ğŸ“‹ Ù†Ø³Ø®</button>
          <button class="action-btn btn-primary" id="btn-random">ğŸ² Ø³Ø¤Ø§Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
          <button class="action-btn btn-ai" id="btn-ai">âœ¨ Ø³Ø¤Ø§Ù„ Ø°ÙƒÙŠ</button>
        </div>

        <div style="margin-top:1.5rem; border-top:1px solid var(--card-border); padding-top:1rem;">
          <div style="font-size:0.8rem; margin-bottom:0.5rem; opacity:0.7">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ù„Ù„ØªØµÙØ­ Ø§Ù„ÙŠØ¯ÙˆÙŠ):</div>
          <div class="q-list" id="q-list"></div>
        </div>
      </div>
    </main>
  </div>
</div>

<div class="toast-container" id="toast-container"></div>

<div class="modal-overlay" id="memories-modal">
  <div class="modal-box">
    <h3>ğŸ“” Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§ Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3>
    <p style="font-size:0.8rem; opacity:0.7">Ø§ÙƒØªØ¨ÙˆØ§ Ø£Ø¬Ù…Ù„ 5 Ù„Ø­Ø¸Ø§ØªØŒ ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø¬Ù‡Ø§Ø²ÙƒÙ….</p>
    <div id="memories-inputs" style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
      </div>
    <div style="text-align:left; margin-top:15px;">
      <button class="btn-secondary action-btn" style="width:auto; display:inline-block;" onclick="closeModal('memories-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="goals-modal">
  <div class="modal-box">
    <h3>ğŸ¯ Ø£Ù‡Ø¯Ø§ÙÙ†Ø§ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</h3>
    <div id="goals-inputs" style="display:flex; flex-direction:column; gap:10px; margin-top:15px; max-height:300px; overflow-y:auto;">
      </div>
    <div style="text-align:left; margin-top:15px;">
      <button class="btn-secondary action-btn" style="width:auto; display:inline-block;" onclick="closeModal('goals-modal')">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="game-modal">
  <div class="modal-box">
    <h3>ğŸ² Ù„Ø¹Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©</h3>
    <div id="game-content" style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:10px; margin:1rem 0; min-height:80px; display:flex; align-items:center; justify-content:center; text-align:center;">
      Ø§Ø¶ØºØ· "ØªØ­Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯" Ù„Ù„Ø¨Ø¯Ø¡
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn-primary action-btn" onclick="generateGame()">ØªØ­Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯</button>
      <button class="btn-secondary action-btn" onclick="closeModal('game-modal')">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</div>

<script>
  /* =========================================
     1. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Data & State)
     ========================================= */
  const AppState = {
    mode: 'love',
    theme: 'dark',
    questions: [],
    currentQuestion: '',
    audio: { isPlaying: false, isLooping: false }
  };

  // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØºØ±Ø© Ù„Ù„Ø£Ø³Ø¦Ù„Ø© (ÙŠÙ…ÙƒÙ† Ø²ÙŠØ§Ø¯ØªÙ‡Ø§)
  const DB = {
    patterns: [
      "Ø´Ù†Ùˆ Ø£ÙƒØ«Ø± Ø´ÙŠ ØªØ­Ø¨Ù‡ Ø¨Ù€ {topic}ØŸ", "Ù„Ùˆ Ù†Ù‚Ø¯Ø± Ù†ØºÙŠØ± Ø´ÙŠ Ø¨Ù€ {topic}ØŒ Ø´Ù†Ùˆ ØªØ®ØªØ§Ø±ØŸ", 
      "Ø£ÙˆØµÙ Ø¹Ù„Ø§Ù‚ØªÙ†Ø§ Ø¨Ù€ {topic} Ø¨ÙƒÙ„Ù…Ø© ÙˆØ­Ø¯Ø©.", "Ù…ØªÙ‰ Ø¢Ø®Ø± Ù…Ø±Ø© Ø­Ø³ÙŠÙ†Ø§ Ø¨Ù€ {topic} Ø³ÙˆØ§ØŸ",
      "Ø´Ù†Ùˆ Ø§Ù„Ø´ÙŠ Ø§Ù„Ù„ÙŠ ÙŠØ®ÙˆÙÙƒ Ø¨Ø®ØµÙˆØµ {topic}ØŸ", "Ø´Ù†Ùˆ Ø­Ù„Ù…Ùƒ Ø§Ù„Ù…Ø´ØªØ±Ùƒ ÙˆÙŠØ§ÙŠ Ø¨Ø®ØµÙˆØµ {topic}ØŸ"
    ],
    topics: {
      love: ["Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…", "Ø§Ù„ØºÙŠØ±Ø©", "Ø§Ù„Ø«Ù‚Ø©", "Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„", "Ø§Ù„Ø£Ù…Ø§Ù†", "Ø§Ù„Ø­Ù†Ø§Ù†", "Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª"],
      engaged: ["Ø§Ù„Ø¹Ø±Ø³", "Ø§Ù„Ø¨ÙŠØª", "Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©", "Ø§Ù„Ø£Ø·ÙØ§Ù„", "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©", "Ø§Ù„ØªÙØ§Ù‡Ù…"],
      married: ["Ø§Ù„Ø±ÙˆØªÙŠÙ†", "ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¨", "ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯", "Ø§Ù„Ù‡Ø¯ÙˆØ¡", "Ø§Ù„Ø³ÙØ±", "Ø§Ù„Ø¯Ø¹Ù…"],
      special: ["Ø§Ù„ØºÙ…ÙˆØ¶", "Ø§Ù„Ø¬Ù†ÙˆÙ†", "Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©", "Ø§Ù„Ø³Ø±", "Ø§Ù„Ø¶Ø­Ùƒ", "Ø§Ù„ØµØ¯Ø§Ù‚Ø©"]
    },
    gameChallenges: [
      "ØªØ­Ø¯ÙŠ 30 Ø«Ø§Ù†ÙŠØ©: Ø§Ù…Ø¯Ø­ Ø´Ø±ÙŠÙƒÙƒ Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù.", "Ù‚ÙˆÙ„ Ø³Ø± Ù…Ø§ Ù‚Ù„ØªÙ‡ Ù„Ø£Ø­Ø¯ Ù…Ù† Ù‚Ø¨Ù„.",
      "Ù…Ø«Ù‘Ù„ Ù…Ø´Ù‡Ø¯ Ù…Ù† Ø£ÙˆÙ„ Ù„Ù‚Ø§Ø¡ Ø¨ÙŠÙ†ÙƒÙ….", "Ø´ØºÙ„ Ø£ØºÙ†ÙŠØ© ÙˆØ§Ø±Ù‚ØµÙˆØ§ Ø³Ù„Ùˆ (Slow) Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø©.",
      "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ Ù‚ØµÙŠØ±Ø© ÙˆØ§Ø±Ø³Ù„Ù‡Ø§ Ø§Ù„Ø¢Ù†."
    ]
  };

  /* =========================================
     2. Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Utils)
     ========================================= */
  const $ = (selector) => document.querySelector(selector);
  const $$ = (selector) => document.querySelectorAll(selector);

  function showToast(msg, type = 'normal') {
    const container = $('#toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = type === 'success' ? `<span>âœ”</span> ${msg}` : msg;
    container.appendChild(toast);
    
    // Trigger Reflow
    void toast.offsetWidth; 
    toast.classList.add('show');

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 400);
    }, 3000);
  }

  function typeWriter(text, elementId, speed = 30) {
    const el = document.getElementById(elementId);
    el.innerHTML = '';
    el.classList.add('cursor');
    let i = 0;
    
    function type() {
      if (i < text.length) {
        el.innerHTML += text.charAt(i);
        i++;
        setTimeout(type, speed);
      } else {
        el.classList.remove('cursor');
      }
    }
    type();
  }

  /* =========================================
     3. Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Core Logic)
     ========================================= */
  
  // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…Ø·
  function generateQuestions() {
    const mode = AppState.mode;
    const topics = DB.topics[mode] || DB.topics.love;
    const list = [];
    
    // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø¯Ù…Ø¬ Ø¨Ø³ÙŠØ·Ø©
    DB.patterns.forEach(pat => {
      topics.forEach(top => {
        list.push({
          id: Math.random().toString(36).substr(2, 9),
          text: pat.replace('{topic}', top),
          tag: top
        });
      });
    });

    // Ø®Ù„Ø· Ø¹Ø´ÙˆØ§Ø¦ÙŠ
    AppState.questions = list.sort(() => 0.5 - Math.random());
    renderQuestionList();
    $('#q-count').textContent = `${list.length} Ø³Ø¤Ø§Ù„ Ù…ØªØ§Ø­`;
  }

  function renderQuestionList() {
    const container = $('#q-list');
    container.innerHTML = '';
    
    // Ù†ÙƒØªÙÙŠ Ø¨Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 50 Ø³Ø¤Ø§Ù„ Ù„Ù„Ø£Ø¯Ø§Ø¡
    AppState.questions.slice(0, 50).forEach(q => {
      const div = document.createElement('div');
      div.className = 'q-item';
      div.textContent = q.text;
      div.onclick = () => displayQuestion(q.text);
      container.appendChild(div);
    });
  }

  function displayQuestion(text) {
    AppState.currentQuestion = text;
    typeWriter(text, 'question-text');
    // Scroll text into view on mobile
    if(window.innerWidth < 800) {
      $('.display-area').scrollIntoView({behavior: "smooth", block: "center"});
    }
  }

  /* =========================================
     4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Handlers)
     ========================================= */
  
  // ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø· (Mode)
  $$('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('.mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      AppState.mode = btn.dataset.mode;
      document.documentElement.setAttribute('data-mode', AppState.mode);
      generateQuestions();
      displayQuestion("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø·! Ø§Ø¶ØºØ· Ø³Ø¤Ø§Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ø¨Ø¯Ø¡.");
      showToast(`ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ ÙˆØ¶Ø¹: ${btn.textContent}`, 'success');
    });
  });

  // Ø§Ù„Ø«ÙŠÙ… (Dark/Light)
  $('#theme-toggle').addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    $('#theme-toggle').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
    localStorage.setItem('love_theme', next);
  });

  // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  $('#btn-random').addEventListener('click', () => {
    if(!AppState.questions.length) generateQuestions();
    const rand = AppState.questions[Math.floor(Math.random() * AppState.questions.length)];
    displayQuestion(rand.text);
  });

  $('#btn-ai').addEventListener('click', () => {
    const aiPrompts = [
      "Ø³Ø¤Ø§Ù„ Ø°ÙƒÙŠ: Ù„Ùˆ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù†Ø§ Ø³Ø§Ø¹Ø© ÙˆØ­Ø¯Ø© Ø¨Ø§Ù‚ÙŠØ© Ø¨Ø¹Ù…Ø±Ù†Ø§ØŒ Ø´Ù†Ùˆ ØªØ­Ø¨ ØªÙ‚ÙˆÙ„ÙŠØŸ",
      "Ø³Ø¤Ø§Ù„ Ø°ÙƒÙŠ: Ø´Ù†Ùˆ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ù„ÙŠ ØªØ¹Ù„Ù…ØªÙ‡ Ù…Ù† Ø¹Ù„Ø§Ù‚ØªÙ†Ø§ ÙˆØªØªÙ…Ù†Ù‰ Ù…Ø§ ØªÙ†Ø³Ø§Ù‡ØŸ",
      "ØªØ­Ù„ÙŠÙ„: Ù‡Ù„ ØªØ­Ø³ Ø¥Ù†Ù†Ø§ Ù†ØªØ·ÙˆØ± Ø³ÙˆØ§ØŸ ÙˆÙ„ÙŠØ´ØŸ"
    ];
    const rand = aiPrompts[Math.floor(Math.random() * aiPrompts.length)];
    displayQuestion(rand);
  });

  $('#btn-copy').addEventListener('click', () => {
    if(!AppState.currentQuestion) return showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù„Ù†Ø³Ø®");
    navigator.clipboard.writeText(AppState.currentQuestion).then(() => {
      showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­", "success");
    });
  });

  /* =========================================
     5. Ù…Ø´ØºÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ (Music Player)
     ========================================= */
  const audioEl = $('#main-audio');
  const dropZone = $('#drop-zone');
  const audioInput = $('#audio-input');

  function handleAudioFile(file) {
    if(file.type.startsWith('audio/')) {
      const url = URL.createObjectURL(file);
      audioEl.src = url;
      $('#track-name').textContent = file.name;
      $('#btn-play').disabled = false;
      $('#btn-stop').disabled = false;
      showToast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ", "success");
      audioEl.play();
    } else {
      showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØªÙŠ ÙÙ‚Ø·");
    }
  }

  audioInput.addEventListener('change', (e) => {
    if(e.target.files.length) handleAudioFile(e.target.files[0]);
  });

  // Drag & Drop
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if(e.dataTransfer.files.length) handleAudioFile(e.dataTransfer.files[0]);
  });

  // Controls
  $('#btn-play').onclick = () => {
    if(audioEl.paused) audioEl.play(); else audioEl.pause();
  };
  $('#btn-stop').onclick = () => {
    audioEl.pause();
    audioEl.currentTime = 0;
  };
  $('#btn-loop').onclick = () => {
    audioEl.loop = !audioEl.loop;
    $('#btn-loop').style.color = audioEl.loop ? 'var(--accent)' : 'inherit';
    showToast(audioEl.loop ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙƒØ±Ø§Ø±");
  };

  // Visualizer Animation
  audioEl.onplay = () => {
    $('#btn-play').textContent = 'â¸';
    $('#visualizer').classList.add('playing');
  };
  audioEl.onpause = () => {
    $('#btn-play').textContent = 'â–¶';
    $('#visualizer').classList.remove('playing');
  };

  /* =========================================
     6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© (Storage)
     ========================================= */
  window.openModal = (id) => {
    $(`#${id}`).classList.add('open');
    if(id === 'memories-modal') loadInputs('memories', 5);
    if(id === 'goals-modal') loadInputs('goals', 10);
  };
  
  window.closeModal = (id) => {
    $(`#${id}`).classList.remove('open');
    if(id === 'memories-modal') saveInputs('memories');
    if(id === 'goals-modal') saveInputs('goals');
  };

  window.generateGame = () => {
    const chall = DB.gameChallenges[Math.floor(Math.random() * DB.gameChallenges.length)];
    typeWriter(chall, 'game-content', 20);
  };

  // Local Storage Helpers
  function loadInputs(key, count) {
    const container = $(`#${key}-inputs`);
    if(container.children.length > 0) return; // Loaded already
    
    const saved = JSON.parse(localStorage.getItem(`love_${key}`) || '[]');
    
    for(let i=0; i<count; i++) {
      const input = document.createElement(key === 'memories' ? 'textarea' : 'input');
      input.placeholder = key === 'memories' ? `Ø°ÙƒØ±Ù‰ Ø±Ù‚Ù… ${i+1}...` : `Ù‡Ø¯Ù Ø±Ù‚Ù… ${i+1}...`;
      input.className = 'action-btn btn-secondary';
      input.style.textAlign = 'right';
      input.style.cursor = 'text';
      input.value = saved[i] || '';
      input.onchange = () => saveInputs(key); // Auto save logic
      container.appendChild(input);
    }
  }

  function saveInputs(key) {
    const inputs = $$(`#${key}-inputs ${key === 'memories' ? 'textarea' : 'input'}`);
    const values = Array.from(inputs).map(i => i.value);
    localStorage.setItem(`love_${key}`, JSON.stringify(values));
    if(document.querySelector(`#${key}-modal.open`)) {
     // showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹", "success"); // Optional feedback
    }
  }

  /* =========================================
     7. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ (Init)
     ========================================= */
  (function init() {
    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø«ÙŠÙ…
    const savedTheme = localStorage.getItem('love_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    $('#theme-toggle').textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
    generateQuestions();
  })();

</script>
</body>
</html>
